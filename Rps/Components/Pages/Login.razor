@page "/login"
@rendermode InteractiveServer
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@implements IDisposable

<div class="login-container">
    <div class="login-card">
        <div class="text-center mb-4">
            <h1 class="display-6 fw-bold" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                ğŸ® ê°€ìœ„ë°”ìœ„ë³´
            </h1>
            <p class="text-muted mb-0">ì¹œêµ¬ë“¤ê³¼ ì¦ê¸°ëŠ” ì‹¤ì‹œê°„ ëŒ€ê²°!</p>
        </div>

        <div class="form-group">
            <label for="nickname" class="fw-semibold">ë‹‰ë„¤ì„</label>
            <input
                type="text"
                id="nickname"
                class="form-control"
                @bind="nickname"
                @bind:event="oninput"
                placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (2-20ì)"
                maxlength="20"
                autocomplete="off" />
            <small class="form-text text-muted">
                âœ¨ ê²Œì„ì—ì„œ ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”
            </small>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger d-flex align-items-center" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <div>@errorMessage</div>
            </div>
        }

        <div class="connection-status">
            <span class="status-indicator @GetStatusClass()"></span>
            <span class="fw-medium">@statusMessage</span>
        </div>

        <button
            class="btn btn-primary btn-block shadow-sm"
            @onclick="HandleLogin"
            disabled="@(!IsLoginButtonEnabled())">
            @if (isConnecting)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>ì—°ê²° ì¤‘...</span>
            }
            else
            {
                <span>ğŸš€ ê²Œì„ ì‹œì‘í•˜ê¸°</span>
            }
        </button>

        @if (showRetryButton)
        {
            <button
                class="btn btn-secondary btn-block mt-2 shadow-sm"
                @onclick="RetryConnection">
                ğŸ”„ ë‹¤ì‹œ ì‹œë„
            </button>
        }

        <div class="text-center mt-4">
            <small class="text-muted">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-shield-check me-1" viewBox="0 0 16 16">
                    <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
                    <path d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                </svg>
                ì•ˆì „í•œ ì—°ê²°ë¡œ ë³´í˜¸ë©ë‹ˆë‹¤
            </small>
        </div>
    </div>
</div>

@code {
    private string nickname = "";
    private string errorMessage = "";
    private string statusMessage = "ì—°ê²° ëŒ€ê¸° ì¤‘";
    private bool isConnecting = false;
    private bool isConnected = false;
    private bool showRetryButton = false;
    private DotNetObjectReference<Login>? objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);

            // JavaScript íŒŒì¼ì´ ë¡œë“œë  ë•Œê¹Œì§€ ì¬ì‹œë„
            var maxRetries = 10;
            var retryCount = 0;
            var retryDelay = 100; // ms

            while (retryCount < maxRetries)
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("setLoginComponentReference", objRef);
                    break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
                }
                catch (JSException)
                {
                    retryCount++;
                    if (retryCount >= maxRetries)
                    {
                        statusMessage = "JavaScript ë¡œë”© ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.";
                        StateHasChanged();
                        throw;
                    }
                    await Task.Delay(retryDelay);
                }
            }
        }
    }

    private bool IsLoginButtonEnabled()
    {
        return !isConnecting && !string.IsNullOrWhiteSpace(nickname) && ValidateNickname();
    }

    private bool ValidateNickname()
    {
        errorMessage = "";
        
        if (string.IsNullOrWhiteSpace(nickname))
        {
            return false;
        }

        if (nickname.Trim().Length < 2)
        {
            errorMessage = "ë‹‰ë„¤ì„ì€ ìµœì†Œ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤";
            return false;
        }

        if (nickname.Length > 20)
        {
            errorMessage = "ë‹‰ë„¤ì„ì€ ìµœëŒ€ 20ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤";
            return false;
        }

        if (string.IsNullOrWhiteSpace(nickname.Trim()))
        {
            errorMessage = "ë‹‰ë„¤ì„ì— ê³µë°±ë§Œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
            return false;
        }

        return true;
    }

    private string GetStatusClass()
    {
        if (isConnected) return "status-connected";
        if (isConnecting) return "status-connecting";
        if (showRetryButton) return "status-failed";
        return "status-waiting";
    }

    private async Task HandleLogin()
    {
        if (!ValidateNickname())
        {
            return;
        }

        try
        {
            isConnecting = true;
            showRetryButton = false;
            statusMessage = "ì—°ê²° ì¤‘...";
            StateHasChanged();

            await InitializeSignalR();
            await ConnectToHub();
            await LoginUser(nickname.Trim());
        }
        catch (Exception ex)
        {
            statusMessage = "ì—°ê²° ì‹¤íŒ¨";
            errorMessage = "ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”";
            showRetryButton = true;
            isConnecting = false;
            StateHasChanged();
        }
    }

    private async Task RetryConnection()
    {
        errorMessage = "";
        showRetryButton = false;
        await HandleLogin();
    }

    private async Task InitializeSignalR()
    {
        await JSRuntime.InvokeVoidAsync("initializeSignalR");
    }

    private async Task ConnectToHub()
    {
        await JSRuntime.InvokeVoidAsync("connectToHub");
        isConnected = true;
        statusMessage = "ì—°ê²°ë¨";
        StateHasChanged();
    }

    private async Task LoginUser(string nick)
    {
        await JSRuntime.InvokeVoidAsync("loginUser", nick);
    }

    [JSInvokable]
    public void HandleLoginSuccess(long userId, string userNickname, object statistics)
    {
        isConnecting = false;
        statusMessage = "ë¡œê·¸ì¸ ì„±ê³µ";
        
        // Navigate to lobby with query parameters
        NavigationManager.NavigateTo($"/lobby?userId={userId}&nickname={Uri.EscapeDataString(userNickname)}");
    }

    [JSInvokable]
    public void HandleLoginFailed(string error)
    {
        isConnecting = false;
        isConnected = false;
        statusMessage = "ë¡œê·¸ì¸ ì‹¤íŒ¨";
        errorMessage = error;
        showRetryButton = true;
        StateHasChanged();
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
