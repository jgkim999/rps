@page "/lobby"
@rendermode InteractiveServer
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@using Rps.Models
@implements IDisposable

<div class="lobby-container">
    <div class="lobby-card">
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                ğŸ® ê²Œì„ ë¡œë¹„
            </h1>
            <p class="text-muted mb-0">ê²Œì„ ì¤€ë¹„ë¥¼ ì™„ë£Œí•˜ì„¸ìš”!</p>
        </div>

        <!-- ì‚¬ìš©ì ì •ë³´ í‘œì‹œ -->
        <div class="user-info-section">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-circle me-2" viewBox="0 0 16 16" style="vertical-align: -0.2em;">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                </svg>
                ì‚¬ìš©ì ì •ë³´
            </h3>
            <div class="user-details">
                <p class="mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tag-fill me-2" viewBox="0 0 16 16">
                        <path d="M2 1a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l4.586-4.586a1 1 0 0 0 0-1.414l-7-7A1 1 0 0 0 6.586 1H2zm4 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                    </svg>
                    <strong>ë‹‰ë„¤ì„:</strong> @nickname
                </p>
                <p class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-hash me-2" viewBox="0 0 16 16">
                        <path d="M8.39 12.648a1.32 1.32 0 0 0-.015.18c0 .305.21.508.5.508.266 0 .492-.172.555-.477l.554-2.703h1.204c.421 0 .617-.234.617-.547 0-.312-.188-.53-.617-.53h-.985l.516-2.524h1.265c.43 0 .618-.227.618-.547 0-.313-.188-.524-.618-.524h-1.046l.476-2.304a1.06 1.06 0 0 0 .016-.164.51.51 0 0 0-.516-.516.54.54 0 0 0-.539.43l-.523 2.554H7.617l.477-2.304c.008-.04.015-.118.015-.164a.512.512 0 0 0-.523-.516.539.539 0 0 0-.531.43L6.53 5.484H5.414c-.43 0-.617.22-.617.532 0 .312.187.539.617.539h.906l-.515 2.523H4.609c-.421 0-.609.219-.609.531 0 .313.188.547.61.547h.985l-.516 2.492c-.008.04-.015.125-.015.18 0 .305.21.508.5.508.265 0 .492-.172.554-.477l.555-2.703h2.242l-.515 2.492zm-1-6.109h2.266l-.515 2.563H6.859l.532-2.563z"/>
                    </svg>
                    <strong>ì‚¬ìš©ì ID:</strong> @userId
                </p>
            </div>
        </div>

        <!-- ê²Œì„ í†µê³„ í‘œì‹œ -->
        <div class="statistics-section">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-graph-up me-2" viewBox="0 0 16 16" style="vertical-align: -0.2em;">
                    <path fill-rule="evenodd" d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07Z"/>
                </svg>
                ê²Œì„ í†µê³„
            </h3>
            @if (statistics != null)
            {
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ğŸ† ìŠ¹ë¦¬</div>
                        <div class="stat-value text-success">@statistics.Wins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ˜¢ íŒ¨ë°°</div>
                        <div class="stat-value text-danger">@statistics.Losses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ¤ ë¬´ìŠ¹ë¶€</div>
                        <div class="stat-value text-secondary">@statistics.Draws</div>
                    </div>
                </div>

                <div class="stats-grid mt-3">
                    <div class="stat-card">
                        <div class="stat-label">âœŠ ë°”ìœ„</div>
                        <div class="stat-value">@statistics.RockCount</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">âœ‹ ë³´</div>
                        <div class="stat-value">@statistics.PaperCount</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">âœŒï¸ ê°€ìœ„</div>
                        <div class="stat-value">@statistics.ScissorsCount</div>
                    </div>
                </div>

                <div class="win-rate mt-3">
                    <strong>ğŸ¯ ìŠ¹ë¥ :</strong> @statistics.WinRate.ToString("F1")%
                    <span class="text-muted">(@statistics.TotalGames ê²Œì„ í”Œë ˆì´)</span>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                    </div>
                    <p class="text-muted mb-0">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            }
        </div>

        <!-- ì†ëª¨ì–‘ ìŠ¤í‚¨ ì„ íƒ -->
        <div class="skin-selection-section">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-palette-fill me-2" viewBox="0 0 16 16" style="vertical-align: -0.2em;">
                    <path d="M12.433 10.07C14.133 10.585 16 11.15 16 8a8 8 0 1 0-8 8c1.996 0 1.826-1.504 1.649-3.08-.124-1.101-.252-2.237.351-2.92.465-.527 1.42-.237 2.433.07zM8 5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm4.5 3a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zM5 6.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                </svg>
                ì†ëª¨ì–‘ ìŠ¤í‚¨ ì„ íƒ
            </h3>
            <div class="skin-options">
                <div class="skin-option @(selectedSkin == 0 ? "selected" : "")" @onclick="() => SelectSkinOption(0)">
                    <img src="/images/skins/skin1.svg" alt="ìŠ¤í‚¨ 1" class="skin-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <div style="display:none; font-size: 80px; margin-bottom: 15px;">âœŠâœ‹âœŒï¸</div>
                    <p>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star-fill me-1" viewBox="0 0 16 16">
                            <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                        </svg>
                        í´ë˜ì‹ ìŠ¤í‚¨
                    </p>
                </div>
                <div class="skin-option @(selectedSkin == 1 ? "selected" : "")" @onclick="() => SelectSkinOption(1)">
                    <img src="/images/skins/skin2.svg" alt="ìŠ¤í‚¨ 2" class="skin-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <div style="display:none; font-size: 80px; margin-bottom: 15px;">ğŸ‘ŠğŸ–ï¸âœŒï¸</div>
                    <p>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightning-fill me-1" viewBox="0 0 16 16">
                            <path d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641l2.5-8.5z"/>
                        </svg>
                        ëª¨ë˜ ìŠ¤í‚¨
                    </p>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(skinMessage))
            {
                <div class="alert @(skinMessageType == "success" ? "alert-success" : "alert-danger") mt-3 d-flex align-items-center" role="alert">
                    @if (skinMessageType == "success")
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle-fill me-2" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                        </svg>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                    }
                    <div>@skinMessage</div>
                </div>
            }
        </div>

        <!-- ê²Œì„ ì‹œì‘ ë²„íŠ¼ -->
        <button
            class="btn btn-success btn-block btn-lg mt-4 shadow-sm"
            disabled="@(!isSkinSelected)"
            @onclick="StartGame">
            @if (isSkinSelected)
            {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-play-circle-fill me-2" viewBox="0 0 16 16" style="vertical-align: -0.2em;">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/>
                </svg>
                <span>ê²Œì„ ì‹œì‘í•˜ê¸°</span>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-hand-index-thumb me-2" viewBox="0 0 16 16" style="vertical-align: -0.2em;">
                    <path d="M6.75 1a.75.75 0 0 1 .75.75V8a.5.5 0 0 0 1 0V5.467l.086-.004c.317-.012.637-.008.816.027.134.027.294.096.448.182.077.042.15.147.15.314V8a.5.5 0 0 0 1 0V6.435l.106-.01c.316-.024.584-.01.708.04.118.046.3.207.486.43.081.096.15.19.2.259V8.5a.5.5 0 1 0 1 0v-1h.342a1 1 0 0 1 .995 1.1l-.271 2.715a2.5 2.5 0 0 1-.317.991l-1.395 2.442a.5.5 0 0 1-.434.252H6.118a.5.5 0 0 1-.447-.276l-1.232-2.465-2.512-4.185a.517.517 0 0 1 .809-.631l2.41 2.41A.5.5 0 0 0 6 9.5V1.75A.75.75 0 0 1 6.75 1zM8.5 4.466V1.75a1.75 1.75 0 1 0-3.5 0v6.543L3.443 6.736A1.517 1.517 0 0 0 1.07 8.588l2.491 4.153 1.215 2.43A1.5 1.5 0 0 0 6.118 16h6.302a1.5 1.5 0 0 0 1.302-.756l1.395-2.441a3.5 3.5 0 0 0 .444-1.389l.271-2.715a2 2 0 0 0-1.99-2.199h-.581a5.114 5.114 0 0 0-.195-.248c-.191-.229-.51-.568-.88-.716-.364-.146-.846-.132-1.158-.108l-.132.012a1.26 1.26 0 0 0-.56-.642 2.632 2.632 0 0 0-.738-.288c-.31-.062-.739-.058-1.05-.046l-.048.002zm2.094 2.025z"/>
                </svg>
                <span>ìŠ¤í‚¨ì„ ì„ íƒí•˜ì„¸ìš”</span>
            }
        </button>
    </div>
</div>

@code {
    private long userId;
    private string nickname = "";
    private int selectedSkin = 0;
    private UserStatistics? statistics;
    private bool isSkinSelected = false;
    private string skinMessage = "";
    private string skinMessageType = "";
    private DotNetObjectReference<Lobby>? objRef;

    protected override async Task OnInitializedAsync()
    {
        // Parse query parameters
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        var userIdStr = query["userId"];
        var nicknameParam = query["nickname"];
        var selectedSkinStr = query["selectedSkin"];

        if (long.TryParse(userIdStr, out var parsedUserId))
        {
            userId = parsedUserId;
        }
        
        if (int.TryParse(selectedSkinStr, out var parsedSkin))
        {
            selectedSkin = parsedSkin;
            isSkinSelected = true;
        }

        if (!string.IsNullOrEmpty(nicknameParam))
        {
            nickname = nicknameParam;
        }

        // Initialize statistics (will be populated from login success data)
        statistics = new UserStatistics();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);

            // JavaScript íŒŒì¼ì´ ë¡œë“œë  ë•Œê¹Œì§€ ì¬ì‹œë„
            var maxRetries = 10;
            var retryCount = 0;
            var retryDelay = 100; // ms

            while (retryCount < maxRetries)
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("setLobbyComponentReference", objRef);
                    break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
                }
                catch (JSException)
                {
                    retryCount++;
                    if (retryCount >= maxRetries)
                    {
                        skinMessage = "JavaScript ë¡œë”© ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.";
                        skinMessageType = "error";
                        StateHasChanged();
                        throw;
                    }
                    await Task.Delay(retryDelay);
                }
            }

            // Load statistics from sessionStorage
            try
            {
                var statisticsJson = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "userStatistics");
                if (!string.IsNullOrEmpty(statisticsJson))
                {
                    Console.WriteLine($"Loading statistics from sessionStorage: {statisticsJson}");

                    var jsonOptions = new System.Text.Json.JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    };
                    var stats = System.Text.Json.JsonSerializer.Deserialize<UserStatistics>(statisticsJson, jsonOptions);
                    if (stats != null)
                    {
                        statistics = stats;
                        Console.WriteLine($"Statistics loaded successfully: Wins={stats.Wins}, Losses={stats.Losses}, Draws={stats.Draws}");
                        StateHasChanged();
                    }
                    else
                    {
                        Console.WriteLine("Deserialized statistics is null");
                    }

                    // Remove from sessionStorage after loading (security and cleanup)
                    await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "userStatistics");
                }
                else
                {
                    Console.WriteLine("No statistics found in sessionStorage");
                }
            }
            catch (Exception ex)
            {
                // Log error but don't fail the page load
                Console.WriteLine($"Failed to load statistics from sessionStorage: {ex.Message}");
                Console.WriteLine($"Exception details: {ex}");
            }
        }
    }

    private async Task SelectSkinOption(int skinId)
    {
        selectedSkin = skinId;
        skinMessage = "";
        StateHasChanged();

        try
        {
            // Call SelectSkin hub method via JavaScript
            await JSRuntime.InvokeVoidAsync("selectSkin", userId, skinId);
        }
        catch (Exception ex)
        {
            skinMessage = "ìŠ¤í‚¨ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";
            skinMessageType = "error";
            isSkinSelected = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void HandleSkinSelected(int skinId)
    {
        selectedSkin = skinId;
        isSkinSelected = true;
        skinMessage = "ìŠ¤í‚¨ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!";
        skinMessageType = "success";
        StateHasChanged();
    }

    [JSInvokable]
    public void HandleSkinSelectionFailed(string error)
    {
        skinMessage = $"ìŠ¤í‚¨ ì„ íƒ ì‹¤íŒ¨: {error}";
        skinMessageType = "error";
        isSkinSelected = false;
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateStatistics(int wins, int losses, int draws, int rockCount, int paperCount, int scissorsCount)
    {
        statistics = new UserStatistics
        {
            Wins = wins,
            Losses = losses,
            Draws = draws,
            RockCount = rockCount,
            PaperCount = paperCount,
            ScissorsCount = scissorsCount
        };
        StateHasChanged();
    }

    private void StartGame()
    {
        // TODO: Navigate to game page or start game logic
        // This will be implemented in future tasks
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
